# AI综合分析管理平台 - 技术方案设计

## 1. 技术架构概述

### 1.1 整体架构
基于微服务架构设计，采用前后端分离模式：
- **前端**：Vue.js 3 + Element Plus + TypeScript
- **后端**：Python FastAPI + SQLAlchemy + Celery
- **数据库**：PostgreSQL（主库）+ Redis（缓存/队列）
- **消息队列**：Redis + Celery
- **部署**：Docker + Docker Compose

### 1.2 核心模块划分
```
ai-analysis-platform/
├── backend/                 # 后端服务
│   ├── app/
│   │   ├── api/            # API路由
│   │   ├── core/           # 核心配置
│   │   ├── models/         # 数据模型
│   │   ├── services/       # 业务逻辑
│   │   ├── tasks/          # 异步任务
│   │   └── utils/          # 工具函数
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/               # 前端应用
│   ├── src/
│   │   ├── components/     # 组件
│   │   ├── views/          # 页面
│   │   ├── api/            # API调用
│   │   └── utils/          # 工具函数
│   ├── package.json
│   └── Dockerfile
├── docker-compose.yml      # 容器编排
└── README.md
```

## 2. 数据库设计

### 2.1 核心表结构

#### AI模型配置表 (ai_models)
```sql
CREATE TABLE ai_models (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    model_type VARCHAR(50) NOT NULL, -- OpenAI-Compatible, Gemini, Claude等
    api_endpoint TEXT NOT NULL,
    api_key_encrypted TEXT NOT NULL, -- 加密存储
    default_params JSONB,           -- 默认参数
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 网盘凭证配置表 (storage_credentials)
```sql
CREATE TABLE storage_credentials (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    server_address TEXT NOT NULL,
    protocol_type VARCHAR(20) NOT NULL, -- SMB, NFS, FTP, WebDAV
    username VARCHAR(100) NOT NULL,
    password_encrypted TEXT NOT NULL,   -- 加密存储
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Webhook配置表 (webhooks)
```sql
CREATE TABLE webhooks (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    webhook_id VARCHAR(50) UNIQUE NOT NULL, -- 生成的唯一ID
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### AI分析任务表 (analysis_tasks)
```sql
CREATE TABLE analysis_tasks (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    webhook_id INTEGER REFERENCES webhooks(id),
    ai_model_id INTEGER REFERENCES ai_models(id),
    storage_credential_id INTEGER REFERENCES storage_credentials(id),
    data_extraction_config JSONB,      -- JSONPath配置
    prompt_template TEXT NOT NULL,
    feishu_config JSONB,               -- 飞书API配置
    field_mapping JSONB,               -- 字段映射配置
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 任务执行记录表 (task_executions)
```sql
CREATE TABLE task_executions (
    id SERIAL PRIMARY KEY,
    task_id INTEGER REFERENCES analysis_tasks(id),
    webhook_payload JSONB,
    extracted_data JSONB,
    file_content TEXT,
    ai_response TEXT,
    execution_status VARCHAR(20), -- pending, processing, success, failed
    error_message TEXT,
    token_usage INTEGER,
    execution_time_ms INTEGER,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);
```

## 3. 后端技术实现

### 3.1 核心技术栈
- **FastAPI**: 高性能异步Web框架，自动生成OpenAPI文档
- **SQLAlchemy**: ORM框架，支持异步操作
- **Celery**: 分布式任务队列，处理耗时的AI分析任务
- **Redis**: 缓存和消息队列
- **Cryptography**: 敏感信息加密
- **Pydantic**: 数据验证和序列化

### 3.2 关键服务设计

#### Webhook服务 (webhook_service.py)
```python
class WebhookService:
    async def receive_webhook(self, webhook_id: str, payload: dict):
        """接收Webhook请求，快速响应并异步处理"""
        # 1. 验证webhook_id有效性
        # 2. 记录请求日志
        # 3. 将任务加入Celery队列
        # 4. 立即返回200响应（<200ms）
        
    async def process_webhook_async(self, webhook_id: str, payload: dict):
        """异步处理Webhook任务"""
        # 1. 查找关联的分析任务
        # 2. 提取数据
        # 3. 获取文件内容
        # 4. 调用AI分析
        # 5. 回写结果到飞书
```

#### 文件获取服务 (file_service.py)
```python
class FileService:
    async def get_file_content(self, file_url: str, credential_id: int):
        """流式读取文件内容"""
        # 支持多种协议：SMB, NFS, FTP, WebDAV, HTTP
        # 实现流式读取，避免大文件内存占用
        
    def _get_smb_content(self, url: str, credential: dict):
        """SMB协议文件读取"""
        
    def _get_http_content(self, url: str):
        """HTTP协议文件读取"""
```

#### AI分析服务 (ai_service.py)
```python
class AIService:
    async def analyze_content(self, model_config: dict, prompt: str, content: str):
        """调用AI模型进行分析"""
        # 1. 根据模型类型选择适配器
        # 2. 构建请求参数
        # 3. 调用API
        # 4. 解析响应
        # 5. 记录Token消耗
        
    def _call_openai_compatible(self, config: dict, prompt: str):
        """OpenAI兼容接口调用"""
        
    def _call_gemini(self, config: dict, prompt: str):
        """Google Gemini接口调用"""
```

#### 飞书集成服务 (feishu_service.py)
```python
class FeishuService:
    async def update_task_field(self, task_id: str, field_name: str, value: str, config: dict):
        """更新飞书项目工作项字段"""
        # 1. 获取访问token
        # 2. 构建更新请求
        # 3. 调用飞书API
        # 4. 处理响应和错误
```

### 3.3 安全设计

#### 加密服务 (encryption_service.py)
```python
class EncryptionService:
    def __init__(self):
        self.key = self._load_encryption_key()
        
    def encrypt(self, plaintext: str) -> str:
        """加密敏感信息"""
        
    def decrypt(self, ciphertext: str) -> str:
        """解密敏感信息"""
        
    def _load_encryption_key(self):
        """从环境变量或密钥管理服务加载密钥"""
```

## 4. 前端技术实现

### 4.1 技术栈
- **Vue.js 3**: 渐进式JavaScript框架
- **Element Plus**: Vue 3 UI组件库
- **TypeScript**: 类型安全
- **Pinia**: 状态管理
- **Vue Router**: 路由管理
- **Axios**: HTTP客户端

### 4.2 页面结构设计

#### 主要页面
1. **配置管理页面**
   - AI模型配置
   - 网盘凭证配置
   
2. **Webhook管理页面**
   - Webhook列表
   - 创建/编辑Webhook
   - 请求日志查看
   
3. **任务管理页面**
   - 任务列表
   - 任务创建向导
   - 任务监控面板
   
4. **监控分析页面**
   - 执行历史
   - Token消耗统计
   - 错误分析

### 4.3 关键组件设计

#### 任务创建向导组件
```vue
<template>
  <el-steps :active="currentStep" finish-status="success">
    <el-step title="基本信息" />
    <el-step title="触发器配置" />
    <el-step title="数据解析配置" />
    <el-step title="文件获取配置" />
    <el-step title="AI分析配置" />
    <el-step title="结果回写配置" />
  </el-steps>
  
  <!-- 步骤内容 -->
  <component :is="currentStepComponent" v-model="taskConfig" />
</template>
```

#### JSONPath测试组件
```vue
<template>
  <div class="json-path-tester">
    <el-row :gutter="20">
      <el-col :span="12">
        <h4>示例JSON数据</h4>
        <el-input type="textarea" v-model="sampleJson" :rows="10" />
      </el-col>
      <el-col :span="12">
        <h4>提取结果</h4>
        <div class="extraction-results">
          <div v-for="(config, key) in extractionConfig" :key="key">
            <strong>{{ key }}:</strong> {{ extractedData[key] }}
          </div>
        </div>
      </el-col>
    </el-row>
  </div>
</template>
```

## 5. 部署方案

### 5.1 Docker容器化

#### 后端Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 前端Dockerfile
```dockerfile
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
```

#### Docker Compose配置
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: ai_analysis
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ai_analysis
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  celery:
    build: ./backend
    command: celery -A app.tasks worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/ai_analysis
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

## 6. 开发计划

### 6.1 第一阶段（MVP版本，2-3周）
- [x] 项目架构搭建
- [ ] 数据库设计和初始化
- [ ] 基础的Webhook接收功能
- [ ] AI模型配置管理
- [ ] 简单的任务执行流程
- [ ] 基础前端界面

### 6.2 第二阶段（完整功能，3-4周）
- [ ] 完整的任务配置向导
- [ ] 多种文件协议支持
- [ ] 飞书API集成
- [ ] 任务监控和日志
- [ ] 错误处理和重试机制

### 6.3 第三阶段（优化完善，2-3周）
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控告警
- [ ] 文档完善
- [ ] 部署自动化

## 7. 风险评估与应对

### 7.1 技术风险
- **文件协议兼容性**：不同网盘协议的实现复杂度
  - 应对：优先支持HTTP/HTTPS，逐步扩展其他协议
  
- **AI模型API稳定性**：外部API的可用性和限流
  - 应对：实现重试机制和降级策略
  
- **大文件处理**：内存占用和处理时间
  - 应对：流式处理和文件大小限制

### 7.2 业务风险
- **飞书API变更**：飞书平台API的变化
  - 应对：抽象化接口设计，便于适配
  
- **安全合规**：敏感数据的处理
  - 应对：严格的加密存储和访问控制

## 8. 监控和运维

### 8.1 日志设计
- **结构化日志**：使用JSON格式，便于分析
- **分级日志**：DEBUG、INFO、WARNING、ERROR
- **关键指标**：响应时间、Token消耗、错误率

### 8.2 监控指标
- **系统指标**：CPU、内存、磁盘使用率
- **业务指标**：任务成功率、平均处理时间、Token消耗
- **错误监控**：异常统计、错误分类

### 8.3 告警机制
- **即时告警**：系统异常、任务失败
- **趋势告警**：性能下降、资源不足
- **通知渠道**：飞书机器人、邮件、短信

## 9. 总结

本技术方案基于现代化的微服务架构，充分考虑了系统的可扩展性、可维护性和安全性。通过Docker容器化部署，可以快速在不同环境中部署和扩展。

关键技术决策：
1. **FastAPI + Vue.js**：现代化的前后端技术栈
2. **异步处理**：Celery队列确保Webhook快速响应
3. **流式文件处理**：避免大文件内存问题
4. **加密存储**：保护敏感凭证信息
5. **模块化设计**：便于功能扩展和维护

该方案能够满足当前需求，同时为未来的功能扩展预留了充分的空间。