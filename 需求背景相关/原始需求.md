1.1 项目背景
为了提升公司内部（特别是项目管理和内容创作流程）的效率，减少重复性的人工分析工作，我们计划开发一个AI综合分析管理平台。当前，许多流程（如美术素材审核、文案合规性分析、测试用例评估等）依赖人工处理存储在内部网盘的文件，并通过飞书项目进行流转。本项目旨在通过AI能力自动化这些分析环节，将分析结果直接回写到飞书项目，实现流程的闭环自动化，从而达成“AI赋能”和“流程优化”的核心目标。

1.2 项目目标
构建通用集成能力：创建一个可配置的平台，能接收来自飞书等系统的Webhook事件。
打通内网数据：实现对公司内网文件（如NAS、内网盘）的安全、高效访问和内容提取。
实现智能分析自动化：支持灵活配置不同的AI模型和提示词（Prompt），对指定文件内容进行自动化分析。
完成流程闭环：将AI分析结果通过API回写至飞书项目，更新对应工作项的状态或字段，减少人工干预。
降本增效：通过自动化分析，节省人力成本，提高项目流转效率，并提供任务级别的成本（Token消耗）度量。

1.3 核心用户与场景
核心用户：AI赋能工程师、项目经理、流程优化负责人。
核心场景：
场景一：美术素材初审：游戏美术团队在飞书项目中提交了新的角色设计稿（存储在公司网盘），触发自动化流程。平台接收到Webhook，获取设计稿文件，使用多模态模型分析其风格是否符合项目要求、是否存在潜在风险等，并将分析结果（如“符合规范”、“建议修改：颜色过于灰暗”）自动更新到飞书任务的“AI审核意见”字段中。
场景二：营销文案合规性检查：市场团队在飞书项目中提交了一篇新的营销文案（以.docx格式存放在网盘），平台自动获取文案内容，使用AI分析是否存在极限词、违反广告法等问题，并将结果（“通过”或“存在风险：‘最强’一词”）回写。

2. 总体设计
2.1 系统架构图
Code snippet
graph TD
    A[飞书项目: 触发工作流] -->|1. 发送HTTP POST请求| B(Webhook网关服务);
    B -->|2. 接收并验证请求| C(任务调度与解析引擎);
    C -->|3. 根据任务配置解析Payload| D(数据解析模块);
    D -->|4. 提取网盘URL和元数据| E(内网文件获取模块);
    subgraph 配置管理中心
        F[AI模型配置];
        G[网盘凭证配置];
        H[任务配置库];
    end
    C -- "读取任务配置" --> H;
    E -- "读取网盘凭证" --> G;
    E -->|5. 流式读取文件内容| I(AI分析调用模块);
    I -- "读取模型配置和Prompt" --> F;
    I -->|6. 调用大语言模型API| J[外部/本地AI模型];
    J -->|7. 返回分析结果| I;
    I -->|8. 格式化结果| K(结果回写模块);
    K -->|9. 调用飞书API更新字段| L[飞书项目: 更新工作项];

    style B fill:#f9f,stroke:#333,stroke-width:2px;
    style C fill:#ccf,stroke:#333,stroke-width:2px;
    style I fill:#cfc,stroke:#333,stroke-width:2px;

2.2 核心流程
触发：用户在飞书项目中完成某个操作（如拖动任务到“待AI分析”列），触发飞书自动化（或类似）流程。
通知：飞书自动化流程向本平台发布的指定Webhook URL发送一个包含任务信息的HTTP POST请求。
接收与解析：平台Webhook服务接收到请求，并根据URL关联到具体的“AI分析任务”。
数据提取：平台根据任务配置，从Webhook的JSON载体中解析出关键字段（如网盘文件路径、飞书任务ID等）。
文件获取：平台使用预先配置好的网盘登录凭证，访问并流式读取目标文件的内容，避免将整个文件下载到平台服务器，以节省空间和提高效率。
AI分析：平台将文件内容和从Webhook中提取的其他元数据，填充到该任务预设的Prompt模板中，然后调用指定的AI模型进行分析。
结果回写：平台接收到AI模型的分析结果，根据任务配置，调用飞书项目的API，将结果更新到指定的飞书工作项的相应字段中。
监控：平台记录本次任务的执行状态、Token消耗、花费时间等信息，用于后续分析。

3. 功能性需求 (Functional Requirements)
3.1 模块一：配置管理
FR-CONF-01: 模型配置管理
描述：管理员可以添加、编辑、删除和查看AI模型配置。
字段：
模型名称 (必填, e.g., "GPT-4o", "Moonshot-Kimi", "内部文生图模型")
模型类型 (必填, 下拉选择: OpenAI-Compatible, Google Gemini, Anthropic Claude, 本地模型等)
API Endpoint (必填, e.g., "https://api.openai.com/v1/chat/completions")
API Key (必填, 需加密存储)
默认模型参数 (可选, e.g., temperature, max_tokens)

FR-CONF-02: 内网网盘登录信息配置
描述：管理员可以配置访问内网文件服务器所需的凭证。
字段：
配置名称 (必填, e.g., "市场部NAS", "美术资源服务器")
服务器地址 (必填, e.g., "smb://192.168.1.100/shared", "nfs://server/exports")
协议类型 (必填, 下拉选择: SMB, NFS, FTP, WebDAV等)
用户名 (必填)
密码/密钥 (必填, 需加密存储)

3.2 模块二：Webhook管理
FR-WEB-01: Webhook发布
描述：用户可以生成一个新的公网可访问的Webhook URL，用于接收外部系统的事件。
功能：
点击“发布新Webhook”按钮。
系统自动生成一个唯一的、难以猜测的URL路径（e.g., https://ai-platform.yourcompany.com/webhook/evt_xxxxxxxxxxxx）。
用户可为该Webhook命名并添加描述（e.g., "飞书美术素材审核触发器"）。
FR-WEB-02: Webhook列表与管理
描述：用户可以查看所有已发布的Webhook及其状态。
界面：以列表形式展示所有Webhook。
信息列：名称, URL, 关联的AI分析任务, 状态 (启用/禁用), 创建时间。
操作：复制URL, 启用/禁用, 查看近期请求日志, 监控生成对应的webhook触发的数据结构内容，删除。

3.3 模块三：AI分析任务管理
FR-TASK-01: 新建/编辑AI分析任务 (建议采用向导式UI)
步骤1：基本信息
任务名称 (必填, e.g., "分析营销文案合规性")
任务描述 (可选)
步骤2：触发器配置
关联Webhook: 从已创建的Webhook列表中选择一个进行绑定。
步骤3：数据解析配置
提供一个UI界面，让用户配置如何从Webhook的JSON数据中提取信息，提取信息可能需要支持编写一些基础的函数来完全相对复杂的数据提取。
实现方式：使用键值对形式，自定义变量名 = JSONPath表达式。
示例：
file_url = $.event.file.url
task_id = $.event.task_id
应提供一个测试区域，可以粘贴示例JSON，点击“解析”后立即看到提取结果。
步骤4：文件获取配置（可选，不是必须的）
文件URL来源: 选择上一步中定义的变量（e.g., file_url）。
网盘凭证: 从“配置管理”中选择一个用于访问该文件的凭证。
步骤5：AI分析配置
选择AI模型: 从“配置管理”中选择一个模型。
Prompt模板: 提供一个富文本编辑器，允许用户编写Prompt。支持插入变量，变量会被实际数据替换。
示例：
你是一个资深的游戏营销文案专家，请分析以下内容是否符合广告法，特别是检查是否存在极限词。
分析结果请直接返回“通过”或“不通过，原因：[具体原因]”。

待分析内容：
"""
{{file_content}}
"""
其中 {{file_content}} 会被实际获取的文件内容替换。
步骤6：结果回写配置
回写目标: 目前固定为“飞书项目”。
飞书项目Task ID: 选择一个变量（e.g., task_id）作为要更新的工作项ID。
字段映射: 配置如何将AI分析结果写入飞书字段。
飞书API的其他配置，飞书项目host地址、插件id、插件密钥、用户id
示例：
飞书字段名 (或字段ID) = AI分析结果
AI审核状态 = AI分析结果 (如果AI结果是"通过"或"不通过")

FR-TASK-02: 任务列表与基础管理
界面：以列表形式展示所有AI分析任务。
信息列：任务名称, 关联Webhook, 状态 (运行中/已停止), 近24小时成功/失败次数。
操作：启动, 停止, 编辑, 删除, 查看执行历史。
FR-TASK-03: 任务监控与分析
描述：点击任务的“执行历史”或进入单独的监控面板。
功能：
查看单个任务的详细执行日志，包括每次触发的时间、输入的Payload、AI返回的原始结果、是否回写成功等。
统计分析每个任务在一段时间内的Token消耗量。

4. 非功能性需求 (Non-Functional Requirements)
4.1 安全性 (Security)
凭证安全：所有API Key和密码必须在数据库中加密存储，绝不能明文。建议使用专门的KMS服务或系统级加密方案。
访问控制：平台应有用户登录和权限管理机制（初期可简化，默认为管理员）。
Webhook安全：生成的Webhook URL应足够随机，防止被恶意扫描。可增加可选的签名验证机制（如飞书开放平台的challenge校验）。
防注入：所有外部输入（Webhook内容、文件内容）在用于构建Prompt和API调用时，必须做适当的清理和转义，防止Prompt注入攻击。
4.2 性能 (Performance)
Webhook响应：Webhook接收端必须能快速响应（< 200ms），确认收到事件，然后将实际的耗时任务放入异步队列中处理，避免让飞书长时间等待。
文件处理：对于大文件，应采用流式读取，避免因内存占用过高导致平台崩溃。
4.3 可靠性 (Reliability)
任务队列与重试：所有AI分析任务都应通过异步消息队列（如RabbitMQ, Celery）执行。对于可恢复的错误（如网络波动、AI模型API超时），应支持自动重试机制。
错误处理与告警：当任务执行失败（如文件无法访问、API Key失效、AI返回错误），应有详细的日志记录，并支持配置告警通知（如通过飞书机器人发送消息给管理员）。
4.4 易用性 (Usability)
清晰的引导：尤其在任务配置环节，提供清晰的步骤指引和示例，降低用户的配置门槛。
即时反馈：在配置数据解析、测试Prompt时，提供即时预览功能，让用户能立刻看到结果。
友好的错误提示：当发生错误时，向用户展示清晰、可操作的错误信息，而不是一串代码。

5. 备选方案与技术选型建议
Webhook vs. 飞书自动化插件
结论：当前选择的Webhook方案更优。
理由：正如您所分析的，Webhook方案通用性极强，不仅限于飞书，未来还可以轻松对接GitLab、Jira、甚至自研系统。开发和维护成本相对较低。虽然插件的定制化和嵌入体验更好，但开发周期长，且与飞书平台强绑定，不符合我们构建“通用平台”的初衷。
技术栈建议 (后端)
语言/框架：Python (生态完善，有大量AI/数据处理库) + FastAPI/Flask (高性能，适合构建API服务)。
数据库：PostgreSQL (功能强大) 或 SQLite (如果初期业务量不大，部署简单)。
异步任务队列：Celery + Redis/RabbitMQ (处理耗时的AI分析任务)。
技术栈建议 (前端)
Vue.js 或 React，配合 Element Plus / Ant Design 等成熟的UI组件库，可以快速构建出专业的管理界面。

6. 其他补充资料
飞书项目API概述：https://project.feishu.cn/b/helpcenter/1p8d7djs/4bsmoql6
获取访问凭证：https://project.feishu.cn/b/helpcenter/1p8d7djs/4id4bvnf
更新工作项（用于更新AI分析的数据）：https://project.feishu.cn/b/helpcenter/1p8d7djs/3e73r2k5
飞书项目webhook说明：https://project.feishu.cn/b/helpcenter/1ykiuvvj/49fq0rvm